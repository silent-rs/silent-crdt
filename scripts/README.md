# Silent-CRDT 测试脚本

这个目录包含了用于测试 Silent-CRDT 系统的各种脚本。

## 本地多节点同步测试

### 功能说明

`test-local-sync` 脚本用于自动测试 README 中描述的本地多节点同步场景，包括：

1. ✅ 启动多个 CRDT 实例（端口 8080 和 8081）
2. ✅ 向第一个实例提交变更
3. ✅ 触发节点间同步
4. ✅ 验证状态收敛（通过状态哈希对比）
5. ✅ 测试双向同步
6. ✅ 自动清理测试环境

### 使用方法

#### 方法 1: 使用 Bash 脚本（推荐 macOS/Linux）

```bash
# 直接运行
./scripts/test-local-sync.sh

# 或通过 Makefile
make test-sync
```

#### 方法 2: 使用 Python 脚本（跨平台）

```bash
# 确保安装了 Python 3 和 requests 库
pip3 install requests

# 运行脚本
python3 scripts/test-local-sync.py

# 或通过 Makefile
make test-sync-py
```

### 测试步骤详解

脚本会自动执行以下步骤：

1. **编译项目** - 使用 `cargo build --release` 编译发布版本
2. **检查端口** - 确保 8080 和 8081 端口可用
3. **启动节点 1** - 在端口 8080 启动第一个节点
4. **启动节点 2** - 在端口 8081 启动第二个节点
5. **提交变更** - 向节点 1 提交以下操作：
   - 添加集合元素: `{"op":"add","key":"user","value":"Alice"}`
   - 增量计数器: `{"op":"increment","key":"counter","delta":5}`
   - 设置寄存器: `{"op":"set","key":"status","value":"active"}`
6. **记录初始状态** - 获取两个节点的状态哈希
7. **触发同步** - 从节点 1 向节点 2 同步
8. **验证收敛** - 确认两个节点的状态哈希一致
9. **反向同步测试** - 向节点 2 添加数据并同步回节点 1
10. **双向验证** - 确认双向同步后状态一致

### 输出示例

```
========================================
Silent-CRDT 本地多节点同步测试
========================================

[步骤 0] 编译项目...
✓ 编译完成

[步骤 1] 检查端口可用性...
✓ 端口检查通过

[步骤 2] 启动节点 1 (端口 8080)...
节点 1 PID: 12345
✓ 端口 8080 上的服务已启动
✓ 节点 1 启动成功

[步骤 3] 启动节点 2 (端口 8081)...
节点 2 PID: 12346
✓ 端口 8081 上的服务已启动
✓ 节点 2 启动成功

[步骤 4] 向节点 1 提交变更...
节点 1 状态哈希: abc123...
✓ 变更提交成功

[步骤 5] 检查节点 2 同步前的状态...
节点 2 状态哈希（同步前）: xyz789...
✓ 同步前两个节点的状态哈希不同（符合预期）

[步骤 6] 触发节点 1 -> 节点 2 的同步...
✓ 同步请求已发送

[步骤 7] 验证节点 2 的状态...
节点 2 状态哈希（同步后）: abc123...

[步骤 8] 验证状态收敛性...
✓✓✓ 状态收敛验证成功！
节点 1 和节点 2 的状态哈希一致

[步骤 10] 测试反向同步...
最终节点 1 哈希: def456...
最终节点 2 哈希: def456...
✓ 双向同步验证成功！

========================================
✓✓✓ 所有测试通过！
========================================

日志文件：
  - 节点 1: node1.log
  - 节点 2: node2.log
```

### 日志文件

测试完成后，可以查看以下日志文件排查问题：

- `node1.log` - 节点 1 的详细日志
- `node2.log` - 节点 2 的详细日志

### 依赖要求

#### Bash 脚本
- `bash` (通常预装)
- `curl` (用于 HTTP 请求)
- `jq` (用于 JSON 解析)
- `lsof` (用于端口检查)

安装 jq:
```bash
# macOS
brew install jq

# Ubuntu/Debian
sudo apt-get install jq

# CentOS/RHEL
sudo yum install jq
```

#### Python 脚本
- Python 3.6+
- `requests` 库

安装依赖:
```bash
pip3 install requests
```

### 故障排除

#### 端口已被占用
如果看到 "端口 8080 已被占用" 错误：
```bash
# 查找占用端口的进程
lsof -i :8080

# 杀死进程
kill -9 <PID>
```

#### 服务启动超时
- 检查 `node1.log` 和 `node2.log` 查看详细错误
- 确保项目编译成功
- 尝试手动启动单个节点测试：
  ```bash
  cargo run -- --port 8080
  ```

#### 状态收敛失败
- 检查网络连接
- 查看日志文件中的错误信息
- 增加 `WAIT_TIME` 等待时间（在脚本中修改）

### 自定义配置

可以在脚本开头修改以下配置：

```bash
PORT1=8080              # 节点 1 端口
PORT2=8081              # 节点 2 端口
NODE1_ID="node1"        # 节点 1 ID
NODE2_ID="node2"        # 节点 2 ID
DATA_DIR1="./test_data/node1"  # 节点 1 数据目录
DATA_DIR2="./test_data/node2"  # 节点 2 数据目录
TIMEOUT=30              # 服务启动超时（秒）
WAIT_TIME=2             # 操作间等待时间（秒）
```

## 清理

测试完成后会自动清理，包括：
- 停止所有启动的节点进程
- 删除测试数据目录 `test_data/`
- 删除日志文件（可选）

如需手动清理：
```bash
# 杀死所有 silent-crdt 进程
pkill -f silent-crdt

# 删除测试数据
rm -rf test_data/

# 删除日志
rm -f node*.log
```
