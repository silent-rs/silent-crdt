# silent-crdt

## é¡¹ç›®æ¦‚è¿°

**silent-crdt** æ˜¯ Silent Odyssey ç¬¬äº”é˜¶æ®µé¡¹ç›®ï¼Œæ—¨åœ¨åŸºäº Silent æ¡†æ¶å®ç° CRDTï¼ˆConflict-free Replicated Data Typesï¼‰åè®®çš„éªŒè¯ä¸å®éªŒã€‚é¡¹ç›®èšç„¦åˆ†å¸ƒå¼ååŒä¸€è‡´æ€§ã€ç¦»çº¿ç¼–è¾‘ä¸çŠ¶æ€è‡ªåŠ¨åˆå¹¶èƒ½åŠ›ï¼Œæ¨åŠ¨ Silent ä½“ç³»åœ¨å¤šèŠ‚ç‚¹ã€å¼±è¿æ¥ç¯å¢ƒä¸‹çš„æ•°æ®åŒæ­¥ä¸å†²çªè§£å†³æ¢ç´¢ã€‚

## åè®®èŒƒå›´ä¸ç›®æ ‡

- æ”¯æŒæ ¸å¿ƒ CRDT æ•°æ®ç»“æ„ï¼ˆå¦‚ GCounterã€PNCounterã€LWW-Registerã€OR-Setã€Map ç­‰ï¼‰
- éªŒè¯å¤šèŠ‚ç‚¹åŒæ­¥ä¸æœ€ç»ˆä¸€è‡´æ€§
- æ”¯æŒç¦»çº¿ç¼–è¾‘ä¸è‡ªåŠ¨åˆå¹¶åœºæ™¯
- æä¾› JSON æ ¼å¼çš„åŒæ­¥æ¥å£ï¼Œä¾¿äºç³»ç»Ÿé›†æˆ

## æ¶æ„è®¾è®¡

å»ºè®®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š
```
src/
â”œâ”€â”€ main.rs          # å¯åŠ¨å…¥å£
â”œâ”€â”€ crdt.rs          # å„ç±» CRDT å®ç°
â”œâ”€â”€ sync.rs          # çŠ¶æ€åŒæ­¥ä¸åˆå¹¶é€»è¾‘
â”œâ”€â”€ storage.rs       # æœ¬åœ°æŒä¹…åŒ–ä¸ç‰ˆæœ¬è®°å½•
â”œâ”€â”€ api.rs           # æä¾› gRPC / HTTP æ¥å£
â””â”€â”€ tests.rs         # ä¸€è‡´æ€§éªŒè¯ä¸å•å…ƒæµ‹è¯•
```

## ä½¿ç”¨ç¤ºä¾‹

å¯åŠ¨æœåŠ¡ï¼š
```bash
cargo run
```

è®¿é—® Web ç›‘æ§é¢æ¿ï¼š
```bash
open http://127.0.0.1:8080
```

åŒæ­¥è¯·æ±‚ç¤ºä¾‹ï¼š
```bash
curl -X POST http://127.0.0.1:8080/sync -d '{"changes":[{"op":"add","key":"note","value":"hello"}]}'
```

## Web ç›‘æ§é¢æ¿

é¡¹ç›®æä¾›äº†ä¸€ä¸ªå®æ—¶ Web ç›‘æ§é¢æ¿ï¼Œå¯ä»¥å¯è§†åŒ–æŸ¥çœ‹ CRDT æ•°æ®çŠ¶æ€ï¼š

- **å®æ—¶çŠ¶æ€ç›‘æ§** - æ˜¾ç¤ºèŠ‚ç‚¹çŠ¶æ€ã€CRDT æ¡ç›®æ•°ã€æ“ä½œæ—¥å¿—æ•°ã€çŠ¶æ€å“ˆå¸Œ
- **æ•°æ®å¯è§†åŒ–** - å±•ç¤ºæ‰€æœ‰ CRDT æ•°æ®ç»“æ„ï¼ˆGCounterã€PNCounterã€LWWRegisterã€ORSetï¼‰
- **å‘é‡æ—¶é’Ÿ** - æŸ¥çœ‹å„èŠ‚ç‚¹çš„å‘é‡æ—¶é’ŸçŠ¶æ€
- **æ“ä½œæ—¥å¿—** - å®æ—¶æ˜¾ç¤ºç³»ç»Ÿæ“ä½œæ—¥å¿—
- **è‡ªåŠ¨åˆ·æ–°** - æ”¯æŒè‡ªåŠ¨åˆ·æ–°ï¼ˆ5ç§’é—´éš”ï¼‰

è®¿é—®åœ°å€ï¼š`http://127.0.0.1:8080/` ï¼ˆé»˜è®¤ç«¯å£ï¼‰


## æµ‹è¯•ä¸éªŒè¯

- æ”¯æŒå¤šå®ä¾‹æ¨¡æ‹Ÿåˆ†å¸ƒå¼åŒæ­¥
- éªŒè¯æœ€ç»ˆä¸€è‡´æ€§ï¼ˆæ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€æ”¶æ•›ï¼‰
- æ€§èƒ½æŒ‡æ ‡ï¼šåˆå¹¶å»¶è¿Ÿã€å†²çªç‡ã€çŠ¶æ€æ”¶æ•›æ—¶é—´

### éªŒè¯åŸç†ä¸æµç¨‹

- æ ¸å¿ƒå±æ€§è¯´æ˜ï¼š
  - æ”¶æ•›æ€§ï¼ˆConvergenceï¼‰ï¼šæ‰€æœ‰å‰¯æœ¬åœ¨ç½‘ç»œæœ€ç»ˆç¨³å®šåè¾¾åˆ°ç›¸åŒçŠ¶æ€ã€‚éªŒè¯æ–¹å¼ï¼šå¯¹å„èŠ‚ç‚¹æœ€ç»ˆçŠ¶æ€ç”Ÿæˆç¡®å®šæ€§å“ˆå¸Œï¼ˆå¦‚åŸºäºåºåˆ—åŒ–åçš„çŠ¶æ€ `state_hash`ï¼‰æˆ–ç»“æ„åŒ–å¿«ç…§ï¼Œå¯¹æ¯”å“ˆå¸Œ/å¿«ç…§æ˜¯å¦ä¸€è‡´ã€‚
  - å¹‚ç­‰æ€§ï¼ˆIdempotenceï¼‰ï¼šåŒä¸€æ‰¹æ“ä½œ/çŠ¶æ€é‡å¤åˆå¹¶ä¸æ”¹å˜ç»“æœã€‚éªŒè¯æ–¹å¼ï¼šå¯¹åŒä¸€å¿«ç…§æ‰§è¡Œå¤šæ¬¡ `merge`ï¼Œæ¯”è¾ƒå‰å `state_hash` æ˜¯å¦ç›¸åŒï¼ŒåŒæ—¶æ£€æŸ¥æ“ä½œæ—¥å¿—é‡å¤åº”ç”¨åçš„çŠ¶æ€ç­‰ä»·ã€‚
  - äº¤æ¢æ€§ï¼ˆCommutativityï¼‰ï¼šå¹¶å‘æ“ä½œçš„åˆå¹¶é¡ºåºä¸å½±å“ç»“æœã€‚éªŒè¯æ–¹å¼ï¼šå¯¹ç›¸åŒæ“ä½œé›†åº”ç”¨ä¸åŒä¹±åºæ’åˆ—å¹¶åˆå¹¶ï¼Œæ¯”è¾ƒæœ€ç»ˆ `state_hash` æ˜¯å¦ä¸€è‡´ã€‚

- Silent-CRDT éªŒè¯æœºåˆ¶ï¼ˆå»ºè®®å®ç°/å¯¹æ¥ï¼‰ï¼š
  - æ“ä½œæ—¥å¿—ï¼ˆOpLogï¼‰ï¼šä¸ºæ¯æ¡å˜æ›´è®°å½•æ“ä½œ IDï¼ˆæ¨è `scru128`ï¼‰ã€å› æœå…ƒæ•°æ®ä¸æ“ä½œå†…å®¹ï¼Œç”¨äºé‡æ”¾ä¸å¤–éƒ¨éªŒè¯ã€‚
  - ç‰ˆæœ¬å‘é‡ / å‘é‡æ—¶é’Ÿï¼šåœ¨ `merge` æ—¶ç”¨äºåˆ¤å®šå¹¶å‘ä¸å› æœå…³ç³»ï¼Œè¾…åŠ©æ£€æµ‹ç¼ºå¤±æˆ–é‡å¤æ¶ˆæ¯ã€‚
  - çŠ¶æ€å“ˆå¸Œï¼šå¯¹ CRDT è§„èŒƒåŒ–çŠ¶æ€ï¼ˆæ’åºåçš„é”®é›†ã€å› æœå…ƒä¿¡æ¯ï¼‰è¿›è¡Œå“ˆå¸Œï¼Œä½œä¸ºæœ€ç»ˆä¸€è‡´æ€§çš„åˆ¤æ®ï¼›åŒæ—¶å¯è¾“å‡ºåˆ°éªŒè¯æŠ¥å‘Šã€‚

- è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹ï¼ˆæ ‡å‡†æ­¥éª¤ï¼‰ï¼š
  1. å¤šèŠ‚ç‚¹åˆå§‹åŒ–ï¼šåˆ›å»º N ä¸ªé€»è¾‘å‰¯æœ¬ï¼Œåˆ†åˆ«åˆ†é…èŠ‚ç‚¹ IDã€‚
  2. å„èŠ‚ç‚¹ç‹¬ç«‹æ‰§è¡Œæ“ä½œï¼šéšæœºæˆ–é¢„è®¾æ“ä½œåºåˆ—ï¼Œå†™å…¥å„è‡ª OpLogã€‚
  3. å»¶è¿Ÿ/ä¹±åºåŒæ­¥ï¼šæ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿã€ä¸¢åŒ…ã€ä¹±åºï¼Œéšæœºé€‰æ‹©å¯¹ç­‰èŠ‚ç‚¹æ‰§è¡Œ `merge`ã€‚
  4. æœ€ç»ˆçŠ¶æ€åˆå¹¶å¯¹æ¯”ï¼šåœ¨ç½‘ç»œâ€œç¨³å®šâ€åæ”¶é›†å„èŠ‚ç‚¹ `state_hash` å¹¶æ–­è¨€ä¸€è‡´ï¼›é‡å¤åˆå¹¶ä»¥éªŒè¯å¹‚ç­‰ã€‚
  5. è¾“å‡ºéªŒè¯æŠ¥å‘Šï¼šæ‰“å°æ”¶æ•›æ€§/å¹‚ç­‰æ€§/äº¤æ¢æ€§ç»“æœä¸æŒ‡æ ‡ç»Ÿè®¡ï¼ˆé€šè¿‡/å¤±è´¥ï¼‰ã€‚

ç¤ºä¾‹å‘½ä»¤ï¼ˆæŒ‰éœ€åœ¨ `tests/` ä¸­æä¾›å¯¹åº”ç”¨ä¾‹ï¼‰ï¼š
```bash
cargo test --test convergence -- --nocapture
cargo test --test idempotence -- --nocapture
cargo test --test commutativity -- --nocapture
```

åœ¨è°ƒè¯•æ—¶å¼€å¯è¯¦ç»†æ—¥å¿—æˆ–è¿½è¸ªç‰¹æ€§ä»¥è§‚å¯Ÿåˆå¹¶äº‹ä»¶ï¼š
```bash
RUST_LOG=debug cargo test --test convergence -- --nocapture
cargo test --features trace --test convergence -- --nocapture
```

### æœ¬åœ°æµ‹è¯•æ­¥éª¤

1. å¯åŠ¨å¤šä¸ª Silent-CRDT å®ä¾‹ï¼ˆä¾‹å¦‚åˆ†åˆ«è¿è¡Œåœ¨ 8080ã€8081 ç«¯å£ï¼‰ï¼š
   ```bash
   cargo run -- --port 8080
   cargo run -- --port 8081
   ```
2. å‘ç¬¬ä¸€ä¸ªå®ä¾‹æäº¤å˜æ›´ï¼š
   ```bash
   curl -X POST http://127.0.0.1:8080/sync -d '{"changes":[{"op":"add","key":"user","value":"Alice"}]}'
   ```
3. è§¦å‘ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„åŒæ­¥ï¼š
   ```bash
   curl -X POST http://127.0.0.1:8080/sync-peer -d '{"peer":"127.0.0.1:8081"}'
   ```
4. æ£€æŸ¥ç¬¬äºŒä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç¡®è®¤æ•°æ®å·²æ”¶æ•›ï¼ˆå¯å¯¹æ¯”çŠ¶æ€å“ˆå¸Œæˆ–çŠ¶æ€å¿«ç…§ï¼‰ã€‚

### å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•

- ä½¿ç”¨ `cargo test` è¿è¡Œå•å…ƒæµ‹è¯•ä¸ä¸€è‡´æ€§åœºæ™¯ç”¨ä¾‹ã€‚
- åœ¨ `tests/` ç›®å½•ä¸‹ç¼–å†™å¤šèŠ‚ç‚¹æ¨¡æ‹Ÿç”¨ä¾‹ï¼Œé€šè¿‡å¼‚æ­¥ä»»åŠ¡ä¸æ¦‚ç‡æ€§ç½‘ç»œæ•…éšœï¼ˆå»¶è¿Ÿ/ä¸¢åŒ…/ä¹±åºï¼‰æ¨¡æ‹Ÿå¹¶å‘æ›´æ–°ä¸åŒæ­¥ã€‚
- ä½¿ç”¨ `RUST_LOG=debug` æˆ– `--features trace` è§‚å¯Ÿ `merge`ã€å› æœåˆ¤å®šä¸å†²çªè§£å†³æ—¥å¿—ã€‚

### éªŒè¯å·¥å…·é›†æˆ

- å¤–éƒ¨å·¥å…·å»ºè®®ï¼š
  - `automerge-rs` æµ‹è¯•æ¨¡å—ï¼šå€Ÿé‰´å…¶å¹¶å‘ä¸ç­‰ä»·æ€§æµ‹è¯•æ€è·¯ï¼Œä½œä¸ºå¯¹ç…§å®éªŒæˆ–å›å½’åŸºçº¿ã€‚
  - `jepsen-knossos` / `antidote-verifier`ï¼šç”¨äºå¤–éƒ¨ä¸€è‡´æ€§éªŒè¯ä¸å†å²æ£€æŸ¥ï¼ˆéœ€è¦å°†æ“ä½œæ—¥å¿—å¯¼å‡ºä¸ºå…¶å¯æ¶ˆè´¹æ ¼å¼ï¼‰ã€‚
  - è‡ªå®šä¹‰ Rust éšæœºæµ‹è¯•è„šæœ¬ï¼šåŸºäºç»Ÿä¸€ `Op` ç”Ÿæˆå™¨æ‰¹é‡äº§ç”Ÿéšæœºæ“ä½œä¸ä¹±åºåˆå¹¶ï¼Œè‡ªåŠ¨å‘ç°ä¸æ”¶æ•›åœºæ™¯ã€‚
- å¯¼å‡ºæ“ä½œæ—¥å¿—åˆ° JSONï¼ˆç”¨äºå¤–éƒ¨éªŒè¯æˆ–é‡æ”¾ï¼‰ï¼š
  ```json
  {
    "node": "n1",
    "ops": [
      {
        "id": "01HZX...SCRU128",
        "causal": { "vv": { "n1": 3, "n2": 1 } },
        "ts": 1712312345678,
        "op": { "type": "or-set.add", "key": "k", "val": "v" }
      }
    ]
  }
  ```
  å»ºè®®æä¾›å¯¼å‡ºå‘½ä»¤æˆ– APIï¼ˆä¾‹å¦‚ `GET /oplog?n=n1`ï¼‰ï¼Œå¹¶å°†æ ·ä¾‹æ—¥å¿—ä¿å­˜åˆ° `docs/validation/` ä¾¿äºå¤–éƒ¨å·¥å…·æ¶ˆè´¹ã€‚

### æ€§èƒ½ä¸ä¸€è‡´æ€§éªŒè¯å»ºè®®

- **å»¶è¿Ÿæµ‹è¯•**ï¼šè®°å½•åˆå¹¶æ“ä½œçš„è€—æ—¶ï¼ˆmsï¼‰ã€‚
- **å†²çªæµ‹è¯•**ï¼šåœ¨å¤šèŠ‚ç‚¹åŒæ—¶ä¿®æ”¹åŒä¸€ keyï¼ŒéªŒè¯æœ€ç»ˆåˆå¹¶ç»“æœä¸€è‡´ã€‚
- **å‹åŠ›æµ‹è¯•**ï¼šé€æ­¥å¢åŠ èŠ‚ç‚¹æ•°é‡ä¸æ›´æ–°é¢‘ç‡ï¼Œè§‚å¯Ÿæ”¶æ•›æ—¶é—´å˜åŒ–ã€‚

### æ€§èƒ½éªŒè¯æŒ‡æ ‡

| æŒ‡æ ‡ | å«ä¹‰ |
|------|------|
| åˆå¹¶å»¶è¿Ÿ (ms) | å®Œæˆä¸€æ¬¡ merge æ“ä½œçš„å¹³å‡è€—æ—¶ |
| å†²çªç‡ (%) | å¹¶å‘æ›´æ–°äº§ç”Ÿå†²çªçš„æ¯”ä¾‹ |
| æ”¶æ•›æ—¶é—´ (ms) | æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ä¸€è‡´æ‰€éœ€æ—¶é—´ |
| çŠ¶æ€ä½“ç§¯ (KB) | æ¯èŠ‚ç‚¹çŠ¶æ€æ•°æ®å¤§å° |

åŸºå‡†æµ‹è¯•å»ºè®®ï¼š
- ä½¿ç”¨ `criterion` ç¼–å†™åŸºå‡†ï¼Œç»Ÿè®¡ä¸åŒ CRDT ç±»å‹åœ¨ä¸åŒæ•°æ®è§„æ¨¡ä¸‹çš„åˆå¹¶/åº”ç”¨æ“ä½œè€—æ—¶ã€‚
- ä½¿ç”¨ `cargo bench` åœ¨ CI æˆ–æœ¬åœ°æŒç»­è·Ÿè¸ªå›å½’ï¼š
  ```bash
  cargo bench
  ```
- è®°å½•å¹¶è¾“å‡ºåˆ° `docs/bench/`ï¼Œä¾¿äºå¯¹æ¯”ä¸åŒå®ç°/å‚æ•°çš„å·®å¼‚ã€‚

### å¯è§†åŒ–ä¸ç»“æœåˆ†æ

- å»ºè®®ç”Ÿæˆä»¥ä¸‹æŠ¥å‘Šæˆ–å›¾è¡¨ï¼š
  - å¤šèŠ‚ç‚¹çŠ¶æ€æ”¶æ•›æ›²çº¿ï¼ˆæ—¶é—´-å“ˆå¸Œä¸€è‡´æ€§æ¯”ä¾‹ï¼‰ã€‚
  - æ“ä½œååé‡ä¸åˆå¹¶å»¶è¿Ÿæ•£ç‚¹å›¾ï¼ˆå‘ç°å°¾å»¶è¿Ÿï¼‰ã€‚
  - ä¸åŒèŠ‚ç‚¹åˆå¹¶é¡ºåºçš„ç»“æœå¯¹æ¯”è¡¨ï¼ˆéªŒè¯äº¤æ¢æ€§ï¼‰ã€‚
- Mermaid æ—¶åºå›¾ç¤ºä¾‹ï¼š
  ```mermaid
  sequenceDiagram
      participant A
      participant B
      participant C
      A->>B: åŒæ­¥çŠ¶æ€
      B->>C: åˆå¹¶æ›´æ–°
      C->>A: å›ä¼ ç¡®è®¤ï¼ˆçŠ¶æ€æ”¶æ•›ï¼‰
  ```

è¾“å‡ºéªŒè¯æŠ¥å‘Šç¤ºä¾‹ï¼ˆæ–‡æœ¬ï¼‰ï¼š
```text
Convergence: PASS (N=5, hashes equal)
Idempotence: PASS (repeat merges unchanged)
Commutativity: PASS (3 permutations equal)
Merge p50/p95: 2.1ms / 6.7ms
Conflicts: 3.2% (resolved by CRDT rules)
```

## å½“å‰åŠŸèƒ½ä¸è·¯çº¿å›¾

- âœ… åŸºç¡€ CRDT ç±»å‹ï¼ˆCounter / Set / Mapï¼‰
- ğŸš§ ç½‘ç»œåŒæ­¥æ¥å£ï¼ˆgRPC / HTTPï¼‰
- ğŸš§ å¤šèŠ‚ç‚¹çŠ¶æ€å›æ”¾ä¸å†²çªå¯è§†åŒ–
- âŒ æƒé™æ§åˆ¶ä¸ç‰ˆæœ¬ç­¾å

## å…³è”é¡¹ç›®

- [silent-quic](https://github.com/silent-rs/silent-quic) â€” é«˜æ€§èƒ½ä¼ è¾“å±‚
- [silent-nas](https://github.com/silent-rs/silent-nas) â€” æ–‡ä»¶åŒæ­¥ä¸åˆ†å¸ƒå¼å­˜å‚¨éªŒè¯
